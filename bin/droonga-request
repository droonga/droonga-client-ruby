#!/usr/bin/env ruby
#
# Copyright (C) 2014 Droonga Project
#
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Lesser General Public
# License version 2.1 as published by the Free Software Foundation.
#
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public
# License along with this library; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

require "optparse"
require "yajl"
require "json"

require "droonga/client"

options = {
  :host                => "localhost",
  :port                => 10031,
  :tag                 => "droonga",
  :protocol            => :droonga,
  :timeout             => 1,
  :exit_on_response    => true,
  :receiver_host       => "localhost",
  :receiver_port       => 0,
  :report_request      => false,
  :report_elapsed_time => true,
}

parser = OptionParser.new
parser.banner += " REQUEST_JSON_FILE"
parser.separator("")
parser.separator("Connect:")
parser.on("--host=HOST",
          "Host name to be connected.",
          "(#{options[:host]})") do |host|
  options[:host] = host
end
parser.on("--port=PORT", Integer,
          "Port number to be connected.",
          "(#{options[:port]})") do |port|
  options[:port] = port
end
parser.on("--tag=TAG",
          "Tag name to be used to communicate with Droonga system.",
          "(#{options[:tag]})") do |tag|
  options[:tag] = tag
end
available_protocols = [:droonga, :http]
parser.on("--protocol=PROTOCOL", available_protocols,
          "Protocol to be used to communicate with Droonga system.",
          "[#{available_protocols.join('|')}]",
          "(#{options[:protocol]})") do |protocol|
  options[:protocol] = protocol
end
parser.separator("")
parser.separator("Timeout:")
parser.on("--timeout=TIMEOUT", Integer,
          "Timeout for operations.",
          "(#{options[:timeout]})") do |timeout|
  options[:timeout] = timeout
end
parser.on("--[no-]exit-on-response",
          "Exit when a response is received.",
          "(#{options[:exit_on_response]})") do |exit_on_response|
  options[:exit_on_response] = exit_on_response
end
parser.separator("")
parser.separator("Droonga protocol:")
parser.on("--receiver-host=HOST",
          "Host name to be received a response from Droonga engine.",
          "(#{options[:receiver_host]})") do |host|
  options[:receiver_host] = host
end
parser.on("--receiver-port=PORT", Integer,
          "Port number to be received a response from Droonga engine.",
          "(#{options[:receiver_port]})") do |port|
  options[:receiver_port] = port
end
parser.separator("")
parser.separator("Report:")
parser.on("--[no-]report-request",
          "Reports request message.",
          "(#{options[:report_request]})") do |report_request|
  options[:report_request] = report_request
end
parser.on("--[no-]report-elapsed-time",
          "Reports elapsed time.",
          "(#{options[:report_elapsed_time]})") do |report_elapsed_time|
  options[:report_elapsed_time] = report_elapsed_time
end
request_json_files = parser.parse!(ARGV)

client = Droonga::Client.new(options)
json_parser = Yajl::Parser.new
json_parser.on_parse_complete = lambda do |request_message|
  if options[:report_request]
    message = "Request: "
    begin
      message << JSON.pretty_generate(request_message)
    rescue
      message << request_message.inspect
    end
    message << "\n"
    print(message)
  end
  start = Time.now
  request = client.request(request_message) do |response|
    message = ""
    if options[:report_elapsed_time]
      message << "Elapsed time: #{Time.now - start}\n"
    end
    begin
      message << JSON.pretty_generate(response)
    rescue
      message << response.inspect
    end
    message << "\n"
    print(message)
    break if options[:exit_on_response]
  end
  request.wait
end

if request_json_files.empty?
  json_parser.parse($stdin)
else
  request_json_files.each do |request_json_file|
    File.open(request_json_file) do |input|
      json_parser.parse(input)
    end
  end
end
